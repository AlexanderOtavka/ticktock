<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../event-card/event-card.html">

<dom-module id="event-list">

<style>
  :host {
    display: block;
  }
</style>

<template>
  <template
    is="dom-repeat"
    items="{{events}}"
    filter="{{_getFilter(showHiddenEvents, showHiddenCalendars)}}"
    observe="hidden calendarHidden">
    <event-card
      event-id="[[item.eventId]]"
      calendar-id="[[item.calendarId]]"
      name="[[item.name]]"
      color="[[item.color]]"
      first="[[!index]]"
      opened="[[_isOpened(index, openedIndex)]]"
      duration="{{item.duration}}"
      duration-from-start="[[item.durationFromStart]]"
      starred="{{item.starred}}"
      event-hidden="{{item.hidden}}"
      calendar-hidden="{{item.calendarHidden}}"
      link="[[item.link]]"
      recurrence-id="[[item.recurrenceId]]"
      on-event-open-toggled="_onEventOpenToggled">
    </event-card>
  </template>
</template>

<script>
(function () {
  'use strict';

  Polymer({
    is: 'event-list',

    properties: {
      events: {
        type: Array,
        notify: true,
      },

      // TODO: make openedIndex change when order changes
      openedIndex: {
        type: Number,
        value: 0,
      },
      showHiddenEvents: Boolean,
      showHiddenCalendars: Boolean,
    },

    /**
     * Open an event by id.
     *
     * @param {String} eventId - The event's id.
     */
    openEvent: function (calendarId, eventId) {
      var eventIndex = this._getEventIndex(calendarId, eventId);
      if (eventIndex !== -1) {
        this.openedIndex = eventIndex;
      }
    },

    _isOpened: function (eventIndex, openedIndex) {
      return eventIndex === openedIndex;
    },

    _getEventIndex: function (calendarId, eventId) {
      return this.events.findIndex(function (calendarEvent) {
        return calendarEvent.eventId === eventId &&
               calendarEvent.calendarId === calendarId;
      });
    },

    _getFilter: function (showHiddenEvents, showHiddenCalendars) {
      if (!showHiddenEvents && !showHiddenCalendars) {
        return function (calendarEvent) {
          return !calendarEvent.hidden && !calendarEvent.calendarHidden;
        };
      } else if (!showHiddenEvents) {
        return function (calendarEvent) {
          return !calendarEvent.hidden;
        };
      } else if (!showHiddenCalendars) {
        return function (calendarEvent) {
          return !calendarEvent.calendarHidden;
        };
      } else {
        return null;
      }
    },

    _onEventOpenToggled: function (event) {
      if (event.detail.opened) {
        var old = Polymer.dom(this.root).querySelector('event-card[opened]');
        if (old) {
          old.toggleExpand();
        }

        this.openedIndex = event.model.index;
      } else {
        this.openedIndex = -1;
      }
    },
  });
})();
</script>

</dom-module>
